<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDGM CAMS</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
            font-family: system-ui, -apple-system, sans-serif;
        }
        /* Header ‚Äì fixed at top, full width, stays when sidebar changes */
        .header {
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            z-index: 10;
        }
        .sync-status {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 12px;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
            display: none;
        }
        .sync-status.visible { display: block; }
        .sync-status.syncing { background: #dbeafe; color: #1e40af; border-color: #60a5fa; }
        .sync-status.error { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .header img {
            height: 56px;
            width: auto;
        }
        .date {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.3;
        }
        .date h1 {
            font-size: 1rem;
            font-weight: 600;
        }
        /* Main area: sidebar + content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: row;
            min-height: 0;
            overflow: hidden;
        }
        /* Sidebar ‚Äì left, fixed width */
        .sidebar {
            width: 240px;
            flex-shrink: 0;
            background: #0F5401;
            border-right: 1px solid #0a3a01;
            overflow-y: auto;
            transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.hidden {
            transform: translateX(-240px);
            width: 0;
            border-right: none;
        }
        .sidebar-nav {
            list-style: none;
            padding: 0.5rem 0;
        }
        .sidebar-nav li {
            margin: 0;
        }
        .sidebar-nav a {
            display: block;
            padding: 0.6rem 1rem;
            color: #e8f5e9;
            text-decoration: none;
        }
        .sidebar-nav a:hover {
            background: #1a7a02;
        }
        .sidebar-nav a.active {
            background: #2a9d03;
            font-weight: 600;
            color: #fff;
        }
        /* Content ‚Äì right, fills remaining space */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #fff;
        }
        .content-panel {
            display: none;
        }
        .content-panel.active {
            display: block;
        }
        .btn { padding: 0.4rem 0.75rem; border: 1px solid #888; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .btn:hover { background: #eee; }
        .btn-primary { background: #2563eb; color: #fff; border-color: #2563eb; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-toggle-sidebar { padding: 0.4rem 0.6rem; background: #0F5401; color: #fff; border: 1px solid #0a3a01; cursor: pointer; font-size: 1.1rem; border-radius: 4px; }
        .btn-toggle-sidebar:hover { background: #1a7a02; }
        .msg { margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .msg.success { background: #dcfce7; color: #166534; }
        .msg.error { background: #fee2e2; color: #991b1b; }
        .scan-form { max-width: 400px; }
        .scan-form .field { margin-bottom: 0.75rem; }
        .scan-form label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
        .scan-form input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .data-table th, .data-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #e5e5e5; }
        .data-table th { background: #f5f5f5; font-weight: 600; }
        .panel-toolbar { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .panel-status { color: #666; font-size: 0.9rem; }
        .scan-result { margin-top: 1rem; padding: 2rem; border-radius: 16px; border: 2px solid #e0e0e0; max-width: 500px; width: 90%; background: #fff; }
        .scan-result.found { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-color: #22c55e; box-shadow: 0 8px 24px rgba(34,197,94,0.3); }
        .scan-result.not-found { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-color: #ef4444; box-shadow: 0 8px 24px rgba(239,68,68,0.3); }
        .scan-result h3 { font-size: 2rem; margin-bottom: 1rem; font-weight: 700; }
        .scan-result .line { margin: 0.75rem 0; font-size: 1.25rem; }
        .scan-result .register-btn { margin-top: 1.5rem; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .scan-result-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; pointer-events: none; }
        .scan-result-overlay.open { display: flex; }
        .scan-result-overlay .scan-result { pointer-events: auto; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .scan-result-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; pointer-events: none; }
        .scan-result-overlay.open { display: flex; }
        .scan-result-overlay .scan-result { pointer-events: auto; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal { background: #fff; padding: 1.5rem; border-radius: 8px; max-width: 360px; width: 90%; }
        .modal h3 { margin-bottom: 1rem; }
        .modal .field { margin-bottom: 0.75rem; }
        .modal label { display: block; margin-bottom: 0.25rem; font-weight: 500; }
        .modal input, .modal select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            .header { padding: 0.5rem 1rem; flex-wrap: wrap; }
            .header img { height: 40px; }
            .date h1 { font-size: 0.85rem; }
            .sidebar { width: 200px; }
            .sidebar.hidden { transform: translateX(-200px); }
            .content { padding: 1rem; }
            .panel-toolbar { flex-wrap: wrap; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 0.35rem; }
        }

        @media (max-width: 480px) {
            .header img { height: 32px; }
            .sidebar { width: 180px; }
            .sidebar.hidden { transform: translateX(-180px); }
            .sidebar-nav a { padding: 0.5rem 0.75rem; font-size: 0.9rem; }
            .content { padding: 0.75rem; }
            .scan-result h3 { font-size: 1.5rem; }
            .scan-result .line { font-size: 1rem; }
        }

        /* Aspect ratio optimizations */
        /* 4:3 and 5:4 (more square) - reduce sidebar, optimize vertical space */
        @media (max-aspect-ratio: 4/3) {
            .sidebar { width: 200px; }
            .sidebar.hidden { transform: translateX(-200px); }
            .content { padding: 1rem; }
            .header { padding: 0.5rem 1rem; }
        }

        /* Ultra-wide 21:9 and wider - use horizontal space better */
        @media (min-aspect-ratio: 21/9) {
            .sidebar { width: 280px; }
            .sidebar.hidden { transform: translateX(-280px); }
            .content { padding: 2rem 3rem; }
        }

        /* High resolution displays - scale up elements */
        @media (min-width: 1920px) {
            .header { padding: 1rem 2rem; }
            .header img { height: 64px; }
            .date h1 { font-size: 1.1rem; }
            .sidebar { width: 280px; }
            .sidebar.hidden { transform: translateX(-280px); }
            .sidebar-nav a { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .content { padding: 2rem; font-size: 1.05rem; }
            .btn { font-size: 1rem; padding: 0.5rem 1rem; }
            .data-table { font-size: 1rem; }
            .scan-result h3 { font-size: 2.5rem; }
            .scan-result .line { font-size: 1.5rem; }
        }

        @media (min-width: 2560px) {
            .header { padding: 1.25rem 2.5rem; }
            .header img { height: 72px; }
            .sidebar { width: 320px; }
            .sidebar.hidden { transform: translateX(-320px); }
            .sidebar-nav a { font-size: 1.1rem; padding: 0.85rem 1.5rem; }
            .content { padding: 2.5rem; font-size: 1.1rem; }
            .scan-result h3 { font-size: 3rem; }
            .scan-result .line { font-size: 1.75rem; }
        }

        /* Small height screens - compact vertical spacing */
        @media (max-height: 720px) {
            .header { padding: 0.5rem 1rem; }
            .header img { height: 42px; }
            .content { padding: 1rem; }
            .scan-result { padding: 1.5rem; }
            .scan-result h3 { font-size: 1.75rem; }
        }

        @media (max-height: 600px) {
            .header { padding: 0.4rem 0.75rem; }
            .header img { height: 36px; }
            .date h1 { font-size: 0.85rem; }
            .content { padding: 0.75rem; }
            .sidebar-nav a { padding: 0.5rem 0.75rem; }
            .scan-result { padding: 1.25rem; }
            .scan-result h3 { font-size: 1.5rem; }
            .scan-result .line { font-size: 1rem; }
        }

        /* Ensure tables are scrollable on small screens */
        @media (max-width: 1024px) {
            .data-table { display: block; overflow-x: auto; white-space: nowrap; }
        }

        /* Flexible panel toolbar for all sizes */
        .panel-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
        .panel-toolbar > input[type="search"] { min-width: 150px; flex: 1 1 200px; }
        .panel-toolbar > select { min-width: 100px; }
        .panel-toolbar > button { white-space: nowrap; }

        /* Ensure modals scale properly */
        .modal { max-width: min(90vw, 400px); }
        .scan-result { max-width: min(90vw, 600px); }
    </style>

</head>
<body>
    <!-- Header ‚Äì stays fixed when sidebar navigates -->
    <header class="header">
        <div style="display:flex;align-items:center;gap:1rem;">
            <button type="button" id="btn-toggle-sidebar" class="btn-toggle-sidebar" title="Toggle sidebar">‚ò∞</button>
            <img src="./assets/logo/notre-dame-logo.png" alt="NDGM RFID">
        </div>
        <div class="date">
            <h1 id="header-date">‚Äî</h1>
            <h1 id="header-time">‚Äî</h1>
        </div>
    </header>

    <!-- Main: sidebar + content -->
    <main class="main">
        <!-- Sidebar (left) -->
        <aside class="sidebar">
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="#scan" class="nav-link active" data-panel="scan">Scan</a></li>
                    <li><a href="#logs" class="nav-link" data-panel="logs">Logs</a></li>
                    <li><a href="#users" class="nav-link" data-panel="users">Users</a></li>
                    <li><a href="#about" class="nav-link" data-panel="about">About</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Content -->
        <div class="content">
            <div id="panel-scan" class="content-panel active">
                <div style="max-width:800px;margin:0 auto;padding:2rem 1rem;text-align:center;">
                    <!-- Standby header -->
                    <div style="margin-bottom:2rem;">
                        <img src="./assets/logo/notre-dame-logo-vertical-removebg-preview.png" alt="CAMS Logo" style="height:256px;width:auto;;">
                        <h1 style="font-size:2rem;font-weight:700;color:#0F5401;margin-bottom:0.5rem;">CAMS - Campus Attendance Management System</h1>
                        <p style="font-size:1.25rem;color:#666;margin:0;">Notre Dame of Greater Manila</p>
                    </div>

                    <!-- Instructions -->
                    <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);border:2px solid #86efac;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 4px 12px rgba(15,84,1,0.1);">
                        <div style="font-size:1.5rem;font-weight:600;color:#0F5401;margin-bottom:1rem;">üì± Tap or Scan Your ID</div>
                        <p style="font-size:1.1rem;color:#333;margin:0;">Place your RFID card near the scanner or type your ID number, then press <strong>Enter</strong></p>
                    </div>

                    <!-- Scan input form -->
                    <div class="scan-form" style="max-width:600px;margin:0 auto;">
                        <form id="scan-form" action="javascript:void(0);" method="post">
                            <div class="field" style="margin-bottom:1.5rem;">
                                <input type="text" id="scan-id-number" placeholder="Ready to scan..." autocomplete="off" autofocus style="width:100%;padding:1.25rem;font-size:1.5rem;border:3px solid #0F5401;border-radius:12px;text-align:center;font-weight:600;box-shadow:0 2px 8px rgba(15,84,1,0.15);">
                            </div>
                        </form>

                        <!-- Scanner ID config (collapsed by default) -->
                        <details style="margin-top:1rem;">
                            <summary style="cursor:pointer;color:#666;font-size:0.9rem;padding:0.5rem;">‚öôÔ∏è Scanner Settings</summary>
                            <div style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;max-width:400px;margin-left:auto;margin-right:auto;">
                                <div style="flex:1">
                                    <label for="scan-scanner-id" style="display:block;margin-bottom:0.25rem;font-weight:500;text-align:left;font-size:0.9rem;">Scanner ID</label>
                                    <input type="text" id="scan-scanner-id" placeholder="Scanner ID (e.g. SCANNER-1)" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;" disabled>
                                </div>
                                <div style="flex:0 0 auto;margin-top:22px;">
                                    <button type="button" id="btn-toggle-scanner-lock" class="btn">Unlock</button>
                                </div>
                            </div>
                        </details>

                        <div id="scan-msg" class="msg" style="display: none;margin-top:1.5rem;"></div>
                    </div>

                    <!-- Footer info -->
                    <div style="margin-top:3rem;padding-top:2rem;border-top:1px solid #e5e7eb;color:#999;font-size:0.9rem;">
                        <p style="margin:0;">For assistance, please contact the administrator</p>
                    </div>
                </div>
            </div>

            <div id="panel-logs" class="content-panel">
                <h2>Logs</h2>
                <div class="panel-toolbar">
                    <input type="search" id="logs-search" placeholder="Search name or ID" style="flex:1;padding:0.45rem;border:1px solid #ccc;border-radius:4px;margin-right:0.5rem;">
                    <select id="logs-type-filter" style="padding:0.45rem;border:1px solid #ccc;border-radius:4px;margin-right:0.5rem;">
                        <option value="all">All</option>
                        <option value="in">Time In</option>
                        <option value="out">Time Out</option>
                    </select>
                    <label style="display:flex;align-items:center;gap:0.5rem;margin-right:0.5rem;">
                        <input type="date" id="logs-date-filter" style="padding:0.35rem;border:1px solid #ccc;border-radius:4px;"> 
                        <button type="button" id="btn-clear-logs-date" class="btn" title="Clear date">‚úï</button>
                    </label>
                    <button type="button" class="btn" id="btn-refresh-logs">Refresh</button>
                    <span class="panel-status" id="logs-status" style="margin-left:0.5rem"></span>
                </div>
                <div id="logs-list"></div>
                <div style="margin-top:0.5rem;color:#666;font-size:0.9rem;">Showing logs for: <span id="logs-date-label">All dates</span></div>
            </div>
            <div id="panel-users" class="content-panel">
                <h2>Users</h2>
                <div class="panel-toolbar">
                    <input type="search" id="users-search" placeholder="Search name or ID" style="flex:1;padding:0.45rem;border:1px solid #ccc;border-radius:4px;margin-right:0.5rem;">
                    <select id="users-role-filter" style="padding:0.45rem;border:1px solid #ccc;border-radius:4px;margin-right:0.5rem;">
                        <option value="all">All roles</option>
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="support">Support Personnel</option>
                    </select>
                    <button type="button" class="btn" id="btn-create-user">Create</button>
                    <button type="button" class="btn" id="btn-refresh-users">Refresh</button>
                    <span class="panel-status" id="users-status" style="margin-left:0.5rem"></span>
                </div>
                <div id="users-list"></div>
            </div>
            <div id="panel-about" class="content-panel" >
                <h2>About NDGM Campus Attendance Management System</h2>
                <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.5rem;">
                    <div style="flex:1 1 320px;background:#fbfbff;border:1px solid #eef2ff;padding:1rem;border-radius:8px;">
                        <h3 style="margin-top:0;margin-bottom:0.5rem;">What is NDGM CAMS?</h3>
                        <p style="color:#333;margin:0;font-size:0.95rem;line-height:1.5;">A modern, offline-capable attendance and access logging system that accepts RFID or manual ID entry. Features real-time scanning with modal overlays, automatic offline sync, intelligent caching, and comprehensive user/log management across Student, Faculty, and Support Personnel roles.</p>
                    </div>

                    <div style="flex:1 1 260px;background:#f9fff7;border:1px solid #ecfdf5;padding:1rem;border-radius:8px;">
                        <h3 style="margin-top:0;margin-bottom:0.5rem;">Architecture</h3>
                        <ul style="margin:0;padding-left:1.25rem;color:#333;line-height:1.5">
                            <li><strong>Frontend</strong>: Electron + responsive single-file HTML/JS UI optimized for kiosk displays</li>
                            <li><strong>Backend</strong>: Express.js REST API with MongoDB or in-memory storage</li>
                            <li><strong>Offline Support</strong>: localStorage cache + sync queue with auto-retry</li>
                            <li><strong>Deployment</strong>: Frontend (Vercel), Backend (Render)</li>
                        </ul>
                    </div>
                </div>

                <div style="margin-top:1rem;display:grid;grid-template-columns:1fr;gap:0.75rem;">
                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Scan Panel - Public Kiosk Mode</h3>
                        <p style="margin:0 0 0.5rem 0;color:#444;line-height:1.5;">Redesigned as a public-facing standby screen with large, easy-to-read displays. Scan results appear in centered modal overlays with color-coded status indicators:</p>
                        <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5">
                            <li><strong>üü¢ Time In</strong>: Green gradient with user details and timestamp</li>
                            <li><strong>üî¥ Time Out</strong>: Red gradient showing exit time</li>
                            <li><strong>‚è∏Ô∏è Ignored</strong>: Duplicate tap within cooldown period</li>
                            <li><strong>üì§ Queued (Offline)</strong>: Scan saved locally, will sync when online</li>
                            <li><strong>‚ùå Not Found</strong>: Quick registration button displayed</li>
                        </ul>
                        <p style="margin:0.5rem 0 0 0;color:#666;font-size:0.9rem;">Modals auto-dismiss after 3 seconds, keeping the input focused for continuous scanning.</p>
                    </div>

                    <div style="background:#fffbeb;padding:1rem;border-radius:8px;border:1px solid #fef3c7;">
                        <h3 style="margin:0 0 0.5rem 0">Offline Sync System</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div>
                                <h4 style="margin:0 0 0.25rem 0;font-size:0.95rem;color:#92400e;">Automatic Caching</h4>
                                <ul style="margin:0;padding-left:1.25rem;color:#444;font-size:0.9rem;line-height:1.5">
                                    <li>Logs & Users cached (5min expiry)</li>
                                    <li>Instant fallback when offline</li>
                                    <li>Visual "Offline" indicators</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="margin:0 0 0.25rem 0;font-size:0.95rem;color:#92400e;">Smart Queue</h4>
                                <ul style="margin:0;padding-left:1.25rem;color:#444;font-size:0.9rem;line-height:1.5">
                                    <li>Up to 1,000 scans queued</li>
                                    <li>Auto-sync every 30s + on focus</li>
                                    <li>Original timestamps preserved</li>
                                    <li>5 retry attempts per scan</li>
                                </ul>
                            </div>
                        </div>
                        <p style="margin:0.75rem 0 0 0;color:#92400e;font-size:0.9rem;font-weight:500;">Sync status badge (top-right) shows pending scans ‚Ä¢ Active sync indicator ‚Ä¢ Retry warnings</p>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Logs Panel - Enhanced Tracking</h3>
                        <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5">
                            <li><strong>Status Column</strong>: ‚úì Synced (green) or ‚è≥ Not Synced (pending queue)</li>
                            <li><strong>Date Filter</strong>: Calendar picker for daily/range queries</li>
                            <li><strong>Real-time Search</strong>: Filter by name, ID, or scanner</li>
                            <li><strong>Type Filter</strong>: View In/Out/All entries</li>
                            <li><strong>Sortable Columns</strong>: Click headers to sort by time, name, ID, etc.</li>
                            <li><strong>Live Updates</strong>: Auto-refreshes after successful sync</li>
                        </ul>
                        <p style="margin:0.5rem 0 0 0;color:#666;font-size:0.9rem;">Queued scans appear with yellow background until synced to server.</p>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Users Panel - Role Management</h3>
                        <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5">
                            <li><strong>Three Roles</strong>: Student, Faculty, Support Personnel</li>
                            <li><strong>CRUD Operations</strong>: Create, edit, delete with modal dialogs</li>
                            <li><strong>Role Filter</strong>: Quick filtering by role type</li>
                            <li><strong>Search</strong>: Real-time search by name or ID number</li>
                            <li><strong>Sortable Table</strong>: Click column headers to sort</li>
                        </ul>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
                        <div style="flex:1;">
                            <h3 style="margin:0 0 0.5rem 0">System Behavior</h3>
                            <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5">
                                <li><strong>Scanner Lock/Unlock</strong>: Configure scanner ID with persistent storage</li>
                                <li><strong>Cooldown Protection</strong>: 3-second duplicate tap prevention (configurable via <code>COOLDOWN_MS</code>)</li>
                                <li><strong>Automatic Time-Out</strong>: Second scan closes open log</li>
                                <li><strong>Daily Reset</strong>: Open logs auto-close at 23:59:59.999</li>
                                <li><strong>Sidebar Toggle</strong>: Collapsible navigation (‚öê button) with state persistence</li>
                            </ul>
                        </div>
                        <div style="flex:0 0 200px;background:#f9fafb;padding:0.75rem;border-radius:6px;border:1px solid #e5e7eb;">
                            <div style="font-weight:600;color:#222;margin-bottom:0.5rem;">Pro Tips</div>
                            <div style="color:#666;font-size:0.85rem;line-height:1.4;">
                                ‚Ä¢ Click <strong>Refresh</strong> to force data reload<br>
                                ‚Ä¢ Use <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>I</kbd> for DevTools<br>
                                ‚Ä¢ Check sync badge for pending scans<br>
                                ‚Ä¢ Date filter supports range queries
                            </div>
                        </div>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Responsive Design</h3>
                        <p style="margin:0;color:#444;line-height:1.5;">Fully responsive UI with optimized layouts for:</p>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.5rem;margin-top:0.5rem;">
                            <div style="background:#f9fafb;padding:0.5rem;border-radius:4px;text-align:center;font-size:0.85rem;">Mobile (480px)</div>
                            <div style="background:#f9fafb;padding:0.5rem;border-radius:4px;text-align:center;font-size:0.85rem;">Tablet (768px)</div>
                            <div style="background:#f9fafb;padding:0.5rem;border-radius:4px;text-align:center;font-size:0.85rem;">Desktop (1024px)</div>
                            <div style="background:#f9fafb;padding:0.5rem;border-radius:4px;text-align:center;font-size:0.85rem;">FHD (1920px)</div>
                            <div style="background:#f9fafb;padding:0.5rem;border-radius:4px;text-align:center;font-size:0.85rem;">4K (2560px)</div>
                        </div>
                        <p style="margin:0.5rem 0 0 0;color:#666;font-size:0.9rem;">Supports aspect ratios: 16:9, 4:3, 5:4, 21:9 ‚Ä¢ Height breakpoints for compact displays</p>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Configuration</h3>
                        <p style="margin:0 0 0.5rem 0;color:#444;line-height:1.5;"><strong>localStorage Settings:</strong></p>
                        <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5;font-size:0.9rem;">
                            <li><code>ndgm_api_base</code> ‚Äî Server URL (default: Render deployment)</li>
                            <li><code>ndgm_scanner_id</code> ‚Äî Scanner identifier</li>
                            <li><code>sidebar-hidden</code> ‚Äî Navigation state (true/false)</li>
                            <li><code>ndgm_cache_*</code> ‚Äî Cached logs/users with timestamps</li>
                            <li><code>ndgm_scan_queue</code> ‚Äî Offline scan queue</li>
                        </ul>
                        <p style="margin:0.5rem 0 0 0;color:#666;font-size:0.9rem;">Set to <code>http://localhost:3000</code> for local development. Includes fallback debug API stub.</p>
                    </div>

                    <div style="background:#fff;padding:1rem;border-radius:8px;border:1px solid #eee;">
                        <h3 style="margin:0 0 0.5rem 0">Troubleshooting</h3>
                        <ul style="margin:0;padding-left:1.25rem;color:#444;line-height:1.5">
                            <li><strong>Scans not recording?</strong> Check API base URL and server connectivity. Look for sync badge.</li>
                            <li><strong>Offline mode?</strong> Scans are queued automatically. Yellow badge shows pending count.</li>
                            <li><strong>Cache issues?</strong> Data expires after 5 minutes. Use Refresh or clear localStorage.</li>
                            <li><strong>Console access:</strong> <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>I</kbd> ‚Üí Console tab for logs</li>
                            <li><strong>Manual sync:</strong> <code>window.NDGM_SYNC.syncQueue()</code> in console</li>
                            <li><strong>View queue:</strong> <code>window.NDGM_SYNC.getQueue()</code></li>
                        </ul>
                    </div>

                    <div style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);padding:1.5rem;border-radius:8px;border:1px solid #86efac;margin-top:0.5rem;">
                        <h3 style="margin:0 0 1rem 0;color:#0F5401;">The Creators</h3>
                        <div style="color:#333;line-height:1.8;font-size:1rem;">
                            <div><strong>Rafael Dela Paz</strong> - <a href="mailto:delapazr07@gmail.com" style="color:#0F5401;text-decoration:none;">delapazr07@gmail.com</a></div>
                            <div><strong>Aristotle Peteros</strong></div>
                            <div><strong>Dean Gabriel Nueva</strong></div>
                            <div><strong>Cyryll Jade Racho</strong></div>
                        </div>
                        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #86efac;color:#666;font-size:0.95rem;">
                            <strong>Date:</strong> January 5, 2026
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Register user modal (when scan finds no user) -->
    <div id="register-overlay" class="modal-overlay">
        <div class="modal">
            <h3>Register user</h3>
            <div class="field">
                <label for="reg-name">Name</label>
                <input type="text" id="reg-name" placeholder="Full name">
            </div>
            <div class="field">
                <label for="reg-idNumber">ID Number</label>
                <input type="text" id="reg-idNumber" placeholder="ID / RFID number">
            </div>
            <div class="field">
                <label for="reg-role">Role</label>
                <select id="reg-role">
                    <option value="student">Student</option>
                    <option value="faculty">Faculty</option>
                    <option value="support">Support Personnel</option>
                </select>
            </div>
            <div id="reg-msg" class="msg" style="display: none;"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" id="btn-register-submit">Register</button>
                <button type="button" class="btn" id="btn-register-cancel">Cancel</button>
            </div>
        </div>
    </div>
            <!-- User edit/create modal -->
            <div id="user-modal-overlay" class="modal-overlay">
                <div class="modal">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <h3 id="user-modal-title">User</h3>
                        <button id="btn-user-modal-close" class="btn" style="padding:0.25rem 0.5rem;">‚úï</button>
                    </div>
                    <div class="field">
                        <label for="user-name">Name</label>
                        <input type="text" id="user-name" placeholder="Full name">
                    </div>
                    <div class="field">
                        <label for="user-idNumber">ID Number</label>
                        <input type="text" id="user-idNumber" placeholder="ID / RFID number">
                    </div>
                    <div class="field">
                        <label for="user-role">Role</label>
                        <select id="user-role">
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="support">Support Personnel</option>
                        </select>
                    </div>
                    <div id="user-msg" class="msg" style="display:none;margin-top:0.5rem"></div>
                    <div class="modal-actions" style="margin-top:1rem;justify-content:space-between;">
                        <div>
                            <button type="button" class="btn btn-primary" id="btn-user-save">Save</button>
                            <button type="button" class="btn" id="btn-user-cancel">Cancel</button>
                        </div>
                        <div>
                            <button type="button" class="btn" id="btn-user-delete" style="background:#fee2e2;border-color:#fca5a5;color:#991b1b;">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Scan result modal overlay -->
    <div id="scan-result-overlay" class="scan-result-overlay">
        <div id="scan-result-modal" class="scan-result"></div>
    </div>

    <!-- Run date/time first so it works even if api.js fails; always uses local time, optionally syncs online -->
    <script>
        (function () {
            var dateEl = document.getElementById('header-date');
            var timeEl = document.getElementById('header-time');
            if (!dateEl || !timeEl) return;

            var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            function formatDate(d) {
                return MONTHS[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
            }
            function formatTime(d) {
                var h = d.getHours();
                var m = d.getMinutes();
                var s = d.getSeconds();
                var ampm = h >= 12 ? 'PM' : 'AM';
                var h12 = h % 12 || 12;
                return h12 + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s + ' ' + ampm;
            }

            var source = 'local';
            var onlineBaseTime = null;
            var onlineBaseAt = null;

            function getCurrentTime() {
                if (source === 'online' && onlineBaseTime && onlineBaseAt) {
                    return new Date(onlineBaseTime.getTime() + (Date.now() - onlineBaseAt));
                }
                return new Date();
            }

            function render() {
                try {
                    var d = getCurrentTime();
                    dateEl.textContent = formatDate(d);
                    timeEl.textContent = formatTime(d);
                } catch (e) {}
            }

            render();
            setInterval(render, 1000);


        })();
    </script>
    <!-- Local debug API stub (allows UI to work without external api.js) -->
    <script>
        (function () {
            console.debug('Loading local NDGM_API stub with sample data');

            // Sample users
            const _users = [
                { _id: 'u1', name: 'Alice Johnson', idNumber: 'A1001', role: 'student', dateCreated: new Date(Date.now() - 86400000 * 10).toISOString() },
                { _id: 'u2', name: 'Bob Santos', idNumber: 'B2002', role: 'faculty', dateCreated: new Date(Date.now() - 86400000 * 5).toISOString() },
                { _id: 'u3', name: 'Maria Cruz', idNumber: 'G3003', role: 'support', dateCreated: new Date(Date.now() - 86400000 * 2).toISOString() },
            ];

            // Sample logs (some with timeIn/timeOut pairs)
            const _logs = [
                { timeIn: new Date(Date.now() - 3600 * 1000 * 5).toISOString(), timeOut: new Date(Date.now() - 3600 * 1000 * 2).toISOString(), userName: 'Alice Johnson', userIdNumber: 'A1001', rfidScannerId: 'SCANNER-1' },
                { timeIn: new Date(Date.now() - 3600 * 1000 * 26).toISOString(), timeOut: new Date(Date.now() - 3600 * 1000 * 20).toISOString(), userName: 'Bob Santos', userIdNumber: 'B2002', rfidScannerId: 'SCANNER-1' },
                { timeIn: new Date(Date.now() - 3600 * 1000 * 1).toISOString(), userName: 'Guard Maria', userIdNumber: 'G3003', rfidScannerId: 'SCANNER-2' },
            ];

            // Last tap timestamps for cooldown protection (per user idNumber)
            const _lastTaps = {}; // key: idNumber.toLowerCase() => epoch ms
            const COOLDOWN_MS = 3000; // ignore taps within 3 seconds

            function clone(x) { return JSON.parse(JSON.stringify(x)); }

            function findUserByIdNumber(idNumber) {
                return _users.find(u => (u.idNumber || '').toLowerCase() === (idNumber || '').toLowerCase());
            }

            // Prefer the configured server in localStorage; default to the deployed Render server
            const BASE = (localStorage.getItem('ndgm_api_base') || 'https://ndgm-cams.onrender.com').replace(/\/$/, '');

            async function remoteFetch(path, opts = {}) {
                const url = (path && path.startsWith('/')) ? (BASE + path) : (BASE + '/' + path);
                const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
                const token = localStorage.getItem('ndgm_token');
                if (token) headers.Authorization = 'Bearer ' + token;
                const res = await fetch(url, Object.assign({ headers, credentials: 'omit' }, opts));
                const text = await res.text();
                let data = null;
                try { data = text ? JSON.parse(text) : null; } catch (e) { data = text; }
                if (!res.ok) {
                    const err = new Error(data && data.error ? data.error : res.statusText || 'Request failed');
                    err.status = res.status; err.data = data; throw err;
                }
                return data;
            }

            window.NDGM_API = {
                getBase: () => BASE,
                setBase: (b) => { localStorage.setItem('ndgm_api_base', b); },
                getToken: () => localStorage.getItem('ndgm_token') || 'local-debug',
                setToken: (t) => { if (t) localStorage.setItem('ndgm_token', t); else localStorage.removeItem('ndgm_token'); },
                getStoredUser: () => null,
                clearAuth: () => { localStorage.removeItem('ndgm_token'); },

                get: (path) => {
                    console.debug('API GET', path, 'BASE=', BASE);
                    if (BASE) return remoteFetch(path, { method: 'GET' });
                    if (path && path.indexOf('/api/users') === 0) return Promise.resolve(clone(_users));
                    if (path && path.indexOf('/api/logs') === 0) {
                        try {
                            // Support optional query params (from/to, rfidScannerId, userIdNumber)
                            const u = new URL('http://local' + path);
                            const from = u.searchParams.get('from');
                            const to = u.searchParams.get('to');
                            const scanner = u.searchParams.get('rfidScannerId');
                            const userId = u.searchParams.get('userIdNumber');
                            let out = clone(_logs);
                            if (from || to) {
                                const fromT = from ? new Date(from).getTime() : -Infinity;
                                const toT = to ? new Date(to).getTime() : Infinity;
                                out = out.filter(l => {
                                    const t = new Date(l.timeIn).getTime();
                                    return t >= fromT && t <= toT;
                                });
                            }
                            if (scanner) out = out.filter(l => (l.rfidScannerId || '').toLowerCase() === (scanner || '').toLowerCase());
                            if (userId) out = out.filter(l => (l.userIdNumber || '').toLowerCase() === (userId || '').toLowerCase());
                            return Promise.resolve(out);
                        } catch (e) {
                            return Promise.resolve(clone(_logs));
                        }
                    }
                    return Promise.resolve(clone({}));
                },

                post: (path, body) => {
                    console.debug('API POST', path, body, 'BASE=', BASE);
                    if (BASE) return remoteFetch(path, { method: 'POST', body: JSON.stringify(body) });
                    if (path === '/api/auth/register' || path === '/api/users') {
                        const id = 'u' + (Date.now());
                        const user = { _id: id, name: body.name, idNumber: body.idNumber, role: body.role || 'student', dateCreated: new Date().toISOString() };
                        _users.unshift(user);
                        return Promise.resolve({ user: clone(user) });
                    }
                    if (path === '/api/logs/scan') {
                        const idNumber = body.userIdNumber || body.userId || body.idNumber;
                        const scanner = body.rfidScannerId || body.rfidScannerId || 'SCANNER-1';
                        const user = findUserByIdNumber(idNumber);
                        if (!user) return Promise.resolve({ userFound: false });
                        // cooldown protection
                        const now = Date.now();
                        const key = (user.idNumber || '').toLowerCase();
                        const last = _lastTaps[key] || 0;
                        if (now - last < COOLDOWN_MS) {
                            return Promise.resolve({ userFound: true, user: clone(user), action: 'ignored', log: null, message: 'Ignored duplicate tap (cooldown)' });
                        }
                        // find an open log (timeIn without timeOut) for same user and scanner
                        const openIdx = _logs.findIndex(l => (l.userIdNumber || '').toLowerCase() === key && (l.rfidScannerId || '') === (scanner || '') && !l.timeOut);
                        if (openIdx !== -1) {
                            _logs[openIdx].timeOut = new Date().toISOString();
                            _lastTaps[key] = now;
                            return Promise.resolve({ userFound: true, user: clone(user), action: 'timeOut', log: clone(_logs[openIdx]), message: 'Time out recorded (local stub)' });
                        }
                        // otherwise create a timeIn log entry
                        const entry = { timeIn: new Date().toISOString(), timeOut: null, userName: user.name, userIdNumber: user.idNumber, rfidScannerId: scanner };
                        _logs.unshift(entry);
                        _lastTaps[key] = now;
                        return Promise.resolve({ userFound: true, user: clone(user), action: 'timeIn', log: clone(entry), message: 'Time in recorded (local stub)' });
                    }
                    return Promise.resolve({});
                },

                patch: (path, body) => {
                    console.debug('API PATCH', path, body, 'BASE=', BASE);
                    if (BASE) return remoteFetch(path, { method: 'PATCH', body: JSON.stringify(body) });
                    if (path && path.indexOf('/api/users/') === 0) {
                        const id = path.split('/').pop();
                        const idx = _users.findIndex(u => u._id == id);
                        if (idx === -1) return Promise.reject(new Error('User not found'));
                        _users[idx] = Object.assign({}, _users[idx], body);
                        return Promise.resolve({ user: clone(_users[idx]) });
                    }
                    return Promise.resolve({});
                },

                delete: (path) => {
                    console.debug('API DELETE', path, 'BASE=', BASE);
                    if (BASE) return remoteFetch(path, { method: 'DELETE' });
                    if (path && path.indexOf('/api/users/') === 0) {
                        const id = path.split('/').pop();
                        const idx = _users.findIndex(u => u._id == id);
                        if (idx === -1) return Promise.reject(new Error('User not found'));
                        _users.splice(idx, 1);
                        return Promise.resolve({});
                    }
                    return Promise.resolve({});
                },

                // Auth helpers
                login: (idNumber, password) => { console.debug('API login', idNumber, 'BASE=', BASE); if (BASE) return remoteFetch('/api/auth/login', { method: 'POST', body: JSON.stringify({ idNumber, password }) }); return Promise.resolve({}); },
                logout: () => { console.debug('API logout'); },

                register: (name, idNumber, role) => {
                    console.debug('API register', name, idNumber, role, 'BASE=', BASE);
                    // The server exposes user creation at /api/users ‚Äî call that instead of /api/auth/register
                    if (BASE) {
                        return remoteFetch('/api/users', { method: 'POST', body: JSON.stringify({ name, idNumber, role }) })
                            .then(data => {
                                // server returns the created user object; normalize to { user: ... }
                                return { user: data && (data.user || data) };
                            });
                    }
                    const id = 'u' + (Date.now());
                    const user = { _id: id, name: name, idNumber: idNumber, role: role || 'student', dateCreated: new Date().toISOString() };
                    _users.unshift(user);
                    return Promise.resolve({ user: clone(user) });
                },

                // Scan
                scan: (userIdNumber, rfidScannerId, timestamp) => {
                    console.debug('API scan', userIdNumber, rfidScannerId, timestamp, 'BASE=', BASE);
                    const payload = { userIdNumber, rfidScannerId };
                    if (timestamp) payload.timestamp = timestamp;
                    if (BASE) return remoteFetch('/api/logs/scan', { method: 'POST', body: JSON.stringify(payload) });
                    const scanner = rfidScannerId || 'SCANNER-1';
                    const user = findUserByIdNumber(userIdNumber);
                    if (!user) return Promise.resolve({ userFound: false });
                    // cooldown protection
                    const now = Date.now();
                    const key = (user.idNumber || '').toLowerCase();
                    const last = _lastTaps[key] || 0;
                    if (now - last < COOLDOWN_MS) {
                        return Promise.resolve({ userFound: true, user: clone(user), action: 'ignored', log: null, message: 'Ignored duplicate tap (cooldown)' });
                    }
                    // look for an open log (timeIn without timeOut) for same user and scanner
                    const openIdx = _logs.findIndex(l => (l.userIdNumber || '').toLowerCase() === key && (l.rfidScannerId || '') === (scanner || '') && !l.timeOut);
                    if (openIdx !== -1) {
                        _logs[openIdx].timeOut = new Date().toISOString();
                        _lastTaps[key] = now;
                        return Promise.resolve({ userFound: true, user: clone(user), action: 'timeOut', log: clone(_logs[openIdx]), message: 'Time out recorded (local stub)' });
                    }
                    // otherwise create a timeIn entry
                    const entry = { timeIn: new Date().toISOString(), timeOut: null, userName: user.name, userIdNumber: user.idNumber, rfidScannerId: scanner };
                    _logs.unshift(entry);
                    _lastTaps[key] = now;
                    return Promise.resolve({ userFound: true, user: clone(user), action: 'timeIn', log: clone(entry), message: 'Time in recorded (local stub)' });
                },

                getLogs: () => { console.debug('API getLogs', 'BASE=', BASE); if (BASE) return remoteFetch('/api/logs'); return Promise.resolve(clone(_logs)); },
                getUsers: () => { console.debug('API getUsers', 'BASE=', BASE); if (BASE) return remoteFetch('/api/users'); return Promise.resolve(clone(_users)); },
            };
        })();
    </script>
    <!-- Cache & Offline Sync System -->
    <script>
        (function initCacheAndSync() {
            const CACHE_KEYS = {
                logs: 'ndgm_cache_logs',
                users: 'ndgm_cache_users',
                logsTimestamp: 'ndgm_cache_logs_ts',
                usersTimestamp: 'ndgm_cache_users_ts',
                scanQueue: 'ndgm_scan_queue'
            };
            const CACHE_EXPIRY_MS = 5 * 60 * 1000; // 5 minutes
            const SYNC_INTERVAL_MS = 30 * 1000; // Try sync every 30 seconds
            const MAX_QUEUE_SIZE = 1000;

            // Cache management
            window.NDGM_CACHE = {
                setLogs: function(data) {
                    try {
                        localStorage.setItem(CACHE_KEYS.logs, JSON.stringify(data));
                        localStorage.setItem(CACHE_KEYS.logsTimestamp, Date.now().toString());
                    } catch (e) { console.warn('Cache write failed:', e); }
                },
                getLogs: function() {
                    try {
                        const ts = parseInt(localStorage.getItem(CACHE_KEYS.logsTimestamp) || '0');
                        if (Date.now() - ts > CACHE_EXPIRY_MS) return null;
                        const cached = localStorage.getItem(CACHE_KEYS.logs);
                        return cached ? JSON.parse(cached) : null;
                    } catch (e) { return null; }
                },
                setUsers: function(data) {
                    try {
                        localStorage.setItem(CACHE_KEYS.users, JSON.stringify(data));
                        localStorage.setItem(CACHE_KEYS.usersTimestamp, Date.now().toString());
                    } catch (e) { console.warn('Cache write failed:', e); }
                },
                getUsers: function() {
                    try {
                        const ts = parseInt(localStorage.getItem(CACHE_KEYS.usersTimestamp) || '0');
                        if (Date.now() - ts > CACHE_EXPIRY_MS) return null;
                        const cached = localStorage.getItem(CACHE_KEYS.users);
                        return cached ? JSON.parse(cached) : null;
                    } catch (e) { return null; }
                },
                clearAll: function() {
                    Object.values(CACHE_KEYS).forEach(k => localStorage.removeItem(k));
                }
            };

            // Offline scan queue management
            window.NDGM_SYNC = {
                queueScan: function(userIdNumber, rfidScannerId) {
                    try {
                        const queue = this.getQueue();
                        if (queue.length >= MAX_QUEUE_SIZE) {
                            console.warn('Scan queue full, dropping oldest entry');
                            queue.shift();
                        }
                        queue.push({
                            id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            userIdNumber: userIdNumber,
                            rfidScannerId: rfidScannerId,
                            timestamp: new Date().toISOString(),
                            retries: 0
                        });
                        localStorage.setItem(CACHE_KEYS.scanQueue, JSON.stringify(queue));
                        console.log('Queued scan for later sync:', userIdNumber);
                        this.updateSyncUI();
                        return true;
                    } catch (e) {
                        console.error('Failed to queue scan:', e);
                        return false;
                    }
                },
                getQueue: function() {
                    try {
                        const raw = localStorage.getItem(CACHE_KEYS.scanQueue);
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                },
                clearQueue: function() {
                    localStorage.removeItem(CACHE_KEYS.scanQueue);
                    this.updateSyncUI();
                },
                updateSyncUI: function() {
                    const statusEl = document.getElementById('sync-status');
                    if (!statusEl) return;
                    const queue = this.getQueue();
                    if (queue.length === 0) {
                        statusEl.classList.remove('visible', 'syncing', 'error');
                        statusEl.textContent = '';
                    } else {
                        statusEl.classList.add('visible');
                        statusEl.textContent = `üì§ ${queue.length} scan${queue.length === 1 ? '' : 's'} pending sync`;
                    }
                },
                setSyncing: function(isSyncing) {
                    const statusEl = document.getElementById('sync-status');
                    if (!statusEl) return;
                    if (isSyncing) {
                        statusEl.classList.add('syncing');
                        statusEl.classList.remove('error');
                        const queue = this.getQueue();
                        statusEl.textContent = `‚è≥ Syncing ${queue.length} scan${queue.length === 1 ? '' : 's'}...`;
                    } else {
                        statusEl.classList.remove('syncing');
                        this.updateSyncUI();
                    }
                },
                setError: function(message) {
                    const statusEl = document.getElementById('sync-status');
                    if (!statusEl) return;
                    statusEl.classList.add('visible', 'error');
                    statusEl.classList.remove('syncing');
                    const queue = this.getQueue();
                    statusEl.textContent = `‚ö†Ô∏è ${queue.length} pending (${message})`;
                },
                syncQueue: async function() {
                    const queue = this.getQueue();
                    if (queue.length === 0) return { success: true, synced: 0 };

                    console.log(`Starting sync of ${queue.length} queued scans...`);
                    this.setSyncing(true);

                    let synced = 0;
                    let failed = [];
                    const api = window.NDGM_API;

                    for (const item of queue) {
                        try {
                            // Try to send the scan with original timestamp
                            await api.scan(item.userIdNumber, item.rfidScannerId, item.timestamp);
                            synced++;
                            console.log(`‚úì Synced queued scan: ${item.userIdNumber} (original time: ${item.timestamp})`);
                        } catch (err) {
                            console.warn(`‚úó Failed to sync scan ${item.id}:`, err.message);
                            item.retries = (item.retries || 0) + 1;
                            // Keep in queue if retries < 5
                            if (item.retries < 5) {
                                failed.push(item);
                            } else {
                                console.error(`Dropping scan ${item.id} after ${item.retries} retries`);
                            }
                        }
                    }

                    // Update queue with only failed items
                    localStorage.setItem(CACHE_KEYS.scanQueue, JSON.stringify(failed));
                    this.setSyncing(false);

                    // Refresh logs UI if it's currently visible to show synced items
                    if (synced > 0) {
                        const logsPanel = document.getElementById('panel-logs');
                        if (logsPanel && logsPanel.classList.contains('active')) {
                            // Reload logs to get fresh data including just-synced scans
                            if (typeof loadLogs === 'function') {
                                setTimeout(function() { loadLogs(); }, 500);
                            } else if (typeof applyLogsUi === 'function') {
                                // Just refresh the UI to remove pending indicators
                                setTimeout(function() { applyLogsUi(); }, 100);
                            }
                        }
                    }

                    if (failed.length === 0) {
                        console.log(`‚úì All ${synced} scans synced successfully`);
                        return { success: true, synced, failed: 0 };
                    } else {
                        console.warn(`Partial sync: ${synced} synced, ${failed.length} failed`);
                        this.setError('retry pending');
                        return { success: false, synced, failed: failed.length };
                    }
                }
            };

            // Auto-sync on window focus and periodic interval
            window.addEventListener('focus', function() {
                console.debug('Window focused, checking sync queue...');
                window.NDGM_SYNC.syncQueue();
            });

            setInterval(function() {
                const queue = window.NDGM_SYNC.getQueue();
                if (queue.length > 0) {
                    console.debug('Periodic sync check...');
                    window.NDGM_SYNC.syncQueue();
                }
            }, SYNC_INTERVAL_MS);

            // Initial UI update
            window.NDGM_SYNC.updateSyncUI();

            // Try to sync on page load if there's a queue
            setTimeout(function() {
                const queue = window.NDGM_SYNC.getQueue();
                if (queue.length > 0) {
                    console.log(`Found ${queue.length} queued scans on startup, attempting sync...`);
                    window.NDGM_SYNC.syncQueue();
                }
            }, 2000);
        })();
    </script>
    <script>
        const scanInput = document.getElementById('scan-id-number');

        // Sidebar toggle
        (function setupSidebarToggle() {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.getElementById('btn-toggle-sidebar');
            if (!sidebar || !toggleBtn) return;
            
            let isHidden = localStorage.getItem('sidebar-hidden') === 'true';
            if (isHidden) sidebar.classList.add('hidden');
            
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('hidden');
                isHidden = sidebar.classList.contains('hidden');
                localStorage.setItem('sidebar-hidden', isHidden);
            });
        })();

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const name = link.dataset.panel;
                console.debug('nav click', name);
                const panelId = 'panel-' + name;
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                link.classList.add('active');
                const panel = document.getElementById(panelId);
                if (panel) panel.classList.add('active');
                if (panelId === 'panel-scan' && scanInput) scanInput.focus();
                if (panelId === 'panel-logs') loadLogs();
                if (panelId === 'panel-users') loadUsers();
            });
        });

        // ‚Äî‚Äî‚Äî Scan: RFID reader sends keystrokes like a keyboard; we submit on Enter ‚Äî‚Äî‚Äî
        const api = window.NDGM_API;
        if (!api) console.warn('API unavailable');
        const SCANNER_ID_KEY = 'ndgm_scanner_id';
        function getScannerId() {
            return localStorage.getItem(SCANNER_ID_KEY) || 'SCANNER-1';
        }

        // Scanner ID UI: allow unlocking to edit and persist to localStorage when locked
        (function setupScannerUi() {
            var scannerEl = document.getElementById('scan-scanner-id');
            var toggleBtn = document.getElementById('btn-toggle-scanner-lock');
            if (!scannerEl || !toggleBtn) return;

            function setLocked(locked) {
                scannerEl.disabled = !!locked;
                toggleBtn.textContent = locked ? 'Unlock' : 'Lock';
                if (locked) {
                    // save value when locking
                    var v = (scannerEl.value || '').trim();
                    if (v) localStorage.setItem(SCANNER_ID_KEY, v);
                } else {
                    // focus when unlocked
                    scannerEl.focus();
                }
            }

            // initialize value from storage
            scannerEl.value = localStorage.getItem(SCANNER_ID_KEY) || 'SCANNER-1';
            setLocked(true);

            toggleBtn.addEventListener('click', function () {
                var locked = scannerEl.disabled;
                setLocked(!locked);
            });

            // Allow pressing Enter to lock/save when editing
            scannerEl.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    // lock and save
                    setLocked(true);
                }
            });
        })();

        const scanMsgEl = document.getElementById('scan-msg');
        const scanResultOverlay = document.getElementById('scan-result-overlay');
        const scanResultModal = document.getElementById('scan-result-modal');
        var scanResultTimeout = null;

        function showScanResult(html, className) {
            if (scanResultTimeout) clearTimeout(scanResultTimeout);
            scanResultModal.className = 'scan-result ' + className;
            scanResultModal.innerHTML = html;
            scanResultOverlay.classList.add('open');
            // Auto-dismiss after 3 seconds and refocus input
            scanResultTimeout = setTimeout(function() {
                scanResultOverlay.classList.remove('open');
                if (scanInput) scanInput.focus();
            }, 3000);
        }

        function formatScanTime(d) {
            if (!d) return '‚Äî';
            var x = new Date(d);
            return x.toLocaleString();
        }

        var lastScannedIdForRegister = '';

        async function submitScan() {
            var idNumber = scanInput.value.trim();
            if (!idNumber) return;
            var scannerField = document.getElementById('scan-scanner-id');
            var scannerId = (scannerField && (scannerField.value || '').trim()) || getScannerId();
            scanMsgEl.textContent = 'Checking‚Ä¶';
            scanMsgEl.className = 'msg';
            scanMsgEl.style.display = 'block';
            scanResultOverlay.classList.remove('open');
            scanInput.value = '';
            try {
                var res = await api.scan(idNumber, scannerId);
                scanMsgEl.style.display = 'none';
                
                if (res.userFound) {
                    if (res.action === 'ignored') {
                        var html = '<h3>‚è∏Ô∏è ' + (res.message || 'Ignored') + '</h3>' +
                            '<div class="line"><strong>Name:</strong> ' + (res.user && res.user.name ? res.user.name : '‚Äî') + '</div>' +
                            '<div class="line"><strong>ID Number:</strong> ' + (res.user && res.user.idNumber ? res.user.idNumber : idNumber) + '</div>';
                        showScanResult(html, '');
                    } else {
                        var timeLabel = res.action === 'timeIn' ? 'üü¢ Time In' : 'üî¥ Time Out';
                        var timeVal = res.log && (res.action === 'timeIn' ? res.log.timeIn : res.log.timeOut);
                        var html = '<h3>' + timeLabel + '</h3>' +
                            '<div class="line"><strong>Name:</strong> ' + (res.user && res.user.name ? res.user.name : '‚Äî') + '</div>' +
                            '<div class="line"><strong>ID Number:</strong> ' + (res.user && res.user.idNumber ? res.user.idNumber : idNumber) + '</div>' +
                            '<div class="line"><strong>Time:</strong> ' + formatScanTime(timeVal) + '</div>';
                        showScanResult(html, 'found');
                    }
                } else {
                    lastScannedIdForRegister = idNumber;
                    var html = '<h3>‚ùå No user found</h3><p class="line">ID: <strong>' + idNumber + '</strong></p>' +
                        '<button type="button" class="btn btn-primary register-btn" id="btn-register-user" style="font-size:1.1rem;padding:0.75rem 1.5rem;">Register New User</button>';
                    showScanResult(html, 'not-found');
                    // Wire up the register button (need to do this after DOM update)
                    setTimeout(function() {
                        var btn = document.getElementById('btn-register-user');
                        if (btn) btn.onclick = function() {
                            scanResultOverlay.classList.remove('open');
                            openRegisterModal();
                        };
                    }, 50);
                }
                // Keep input focused for continuous scanning
                setTimeout(function() { if (scanInput) scanInput.focus(); }, 100);
            } catch (err) {
                // Network error - queue for later sync
                const isNetworkError = !err.status || err.message.toLowerCase().includes('fetch') || err.message.toLowerCase().includes('network');
                if (isNetworkError && window.NDGM_SYNC) {
                    const queued = window.NDGM_SYNC.queueScan(idNumber, scannerId);
                    if (queued) {
                        scanMsgEl.style.display = 'none';
                        // Try to find user in cache to show modal
                        var cachedUsers = window.NDGM_CACHE ? window.NDGM_CACHE.getUsers() : null;
                        var user = null;
                        if (cachedUsers && cachedUsers.length > 0) {
                            user = cachedUsers.find(function(u) {
                                return (u.idNumber || '').toLowerCase() === idNumber.toLowerCase();
                            });
                        }
                        if (user) {
                            var html = '<h3>üì§ Queued (Offline)</h3>' +
                                '<div class="line"><strong>Name:</strong> ' + (user.name || '‚Äî') + '</div>' +
                                '<div class="line"><strong>ID Number:</strong> ' + (user.idNumber || idNumber) + '</div>' +
                                '<div class="line"><strong>Time:</strong> ' + formatScanTime(new Date().toISOString()) + '</div>' +
                                '<div class="line" style="color:#92400e;margin-top:0.5rem;">‚ö†Ô∏è Will sync when online</div>';
                            showScanResult(html, '');
                        } else {
                            var html = '<h3>üì§ Queued (Offline)</h3>' +
                                '<div class="line"><strong>ID Number:</strong> ' + idNumber + '</div>' +
                                '<div class="line"><strong>Time:</strong> ' + formatScanTime(new Date().toISOString()) + '</div>' +
                                '<div class="line" style="color:#92400e;margin-top:0.5rem;">‚ö†Ô∏è Will sync when online</div>';
                            showScanResult(html, '');
                        }
                    } else {
                        scanMsgEl.style.display = 'block';
                        scanMsgEl.textContent = 'Failed to queue scan (storage full)';
                        scanMsgEl.className = 'msg error';
                        // Keep input cleared even on storage error
                    }
                } else {
                    scanMsgEl.style.display = 'block';
                    scanMsgEl.textContent = err.data && err.data.error ? err.data.error : (err.message || 'Scan failed.');
                    scanMsgEl.className = 'msg error';
                    // Restore input only for non-network errors (validation errors, etc.)
                    scanInput.value = idNumber;
                }
                // Keep input focused for next scan
                setTimeout(function() { if (scanInput) scanInput.focus(); }, 100);
            }
        }

        // Submit on Enter: form submit (works when focus is in input) + keydown fallback
        document.getElementById('scan-form').addEventListener('submit', function (e) {
            e.preventDefault();
            console.debug('form submit', scanInput.value);
            submitScan();
        });
        scanInput.addEventListener('keydown', function (e) {
            console.debug('scan input keydown', e.key, e.keyCode);
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                submitScan();
            }
        });

        // ‚Äî‚Äî‚Äî Register user modal ‚Äî‚Äî‚Äî
        var registerOverlay = document.getElementById('register-overlay');
        var regName = document.getElementById('reg-name');
        var regIdNumber = document.getElementById('reg-idNumber');
        var regRole = document.getElementById('reg-role');
        var regMsg = document.getElementById('reg-msg');

        function openRegisterModal() {
            regIdNumber.value = lastScannedIdForRegister;
            regName.value = '';
            regRole.value = 'user';
            regMsg.style.display = 'none';
            registerOverlay.classList.add('open');
            regName.focus();
        }

        function closeRegisterModal() {
            registerOverlay.classList.remove('open');
        }

        document.getElementById('btn-register-cancel').addEventListener('click', closeRegisterModal);
        registerOverlay.addEventListener('click', function (e) {
            if (e.target === registerOverlay) closeRegisterModal();
        });

        document.getElementById('btn-register-submit').addEventListener('click', async function () {
            var name = regName.value.trim();
            var idNum = regIdNumber.value.trim();
            var role = regRole.value;
            if (!name || !idNum) {
                regMsg.textContent = 'Name and ID Number are required.';
                regMsg.className = 'msg error';
                regMsg.style.display = 'block';
                return;
            }
            regMsg.style.display = 'none';
            try {
                await api.register(name, idNum, role);
                regMsg.textContent = 'User registered. You can scan again.';
                regMsg.className = 'msg success';
                regMsg.style.display = 'block';
                setTimeout(function () {
                    closeRegisterModal();
                    scanResultEl.style.display = 'none';
                    scanInput.focus();
                }, 1200);
            } catch (err) {
                regMsg.textContent = (err.data && err.data.error) || err.message || 'Registration failed.';
                regMsg.className = 'msg error';
                regMsg.style.display = 'block';
            }
        });

        // ‚Äî‚Äî‚Äî Logs ‚Äî‚Äî‚Äî
        function formatDateTime(d) {
            if (!d) return '‚Äî';
            const x = new Date(d);
            return x.toLocaleString();
        }
        // Logs: client-side searchable, sortable table
        var logsCache = [];
        var logsSort = { by: 'time', dir: -1 }; // dir: 1 asc, -1 desc

        function makeEntriesFromLogs(logs) {
            // Convert each log to one or two entries (timeIn -> In, timeOut -> Out)
            const entries = [];
            (logs || []).forEach(l => {
                if (l.timeIn) entries.push({ time: l.timeIn, type: 'In', name: l.userName || l.user?.name || '‚Äî', idNumber: l.userIdNumber || l.user?.idNumber || '‚Äî', scanner: l.rfidScannerId || l.rfidScannerId || '‚Äî', pending: false });
                if (l.timeOut) entries.push({ time: l.timeOut, type: 'Out', name: l.userName || l.user?.name || '‚Äî', idNumber: l.userIdNumber || l.user?.idNumber || '‚Äî', scanner: l.rfidScannerId || l.rfidScannerId || '‚Äî', pending: false });
            });
            
            // Add queued scans as pending entries
            if (window.NDGM_SYNC) {
                const queue = window.NDGM_SYNC.getQueue();
                const cachedUsers = window.NDGM_CACHE ? window.NDGM_CACHE.getUsers() : [];
                queue.forEach(q => {
                    // Try to find user name from cache
                    let userName = '‚Äî';
                    if (cachedUsers && cachedUsers.length > 0) {
                        const user = cachedUsers.find(u => (u.idNumber || '').toLowerCase() === (q.userIdNumber || '').toLowerCase());
                        if (user) userName = user.name;
                    }
                    entries.push({
                        time: q.timestamp,
                        type: 'In',
                        name: userName,
                        idNumber: q.userIdNumber || '‚Äî',
                        scanner: q.rfidScannerId || '‚Äî',
                        pending: true
                    });
                });
            }
            return entries;
        }

        function renderLogsTable(entries) {
            const listEl = document.getElementById('logs-list');
            if (!entries || entries.length === 0) {
                listEl.innerHTML = '<p class="panel-status">No logs found.</p>';
                return;
            }

            // build table with sortable headers
            const table = document.createElement('table');
            table.className = 'data-table';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const cols = [
                { key: 'time', label: 'Time' },
                { key: 'type', label: 'In/Out' },
                { key: 'name', label: 'Name' },
                { key: 'idNumber', label: 'ID Number' },
                { key: 'scanner', label: 'SC ID' },
                { key: 'status', label: 'Status', noSort: true },
            ];
            cols.forEach(c => {
                const th = document.createElement('th');
                th.textContent = c.label;
                if (!c.noSort) {
                    th.style.cursor = 'pointer';
                    th.addEventListener('click', function () {
                        if (logsSort.by === c.key) logsSort.dir = -logsSort.dir; else { logsSort.by = c.key; logsSort.dir = -1; }
                        applyLogsUi();
                    });
                }
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            entries.forEach(en => {
                const tr = document.createElement('tr');
                if (en.pending) {
                    tr.style.background = '#fef3c7';
                    tr.style.opacity = '0.85';
                }
                const tTime = document.createElement('td'); tTime.textContent = formatDateTime(en.time); tr.appendChild(tTime);
                const tType = document.createElement('td'); tType.textContent = en.type; tr.appendChild(tType);
                const tName = document.createElement('td'); tName.textContent = en.name; tr.appendChild(tName);
                const tId = document.createElement('td'); tId.textContent = en.idNumber; tr.appendChild(tId);
                const tSc = document.createElement('td'); tSc.textContent = en.scanner; tr.appendChild(tSc);
                const tStatus = document.createElement('td');
                if (en.pending) {
                    tStatus.innerHTML = '<span style="color:#92400e;font-size:0.85rem;">‚è≥ Not Synced</span>';
                } else {
                    tStatus.innerHTML = '<span style="color:#16a34a;font-size:0.85rem;">‚úì Synced</span>';
                }
                tr.appendChild(tStatus);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            listEl.innerHTML = '';
            listEl.appendChild(table);
        }

        function applyLogsUi() {
            const statusEl = document.getElementById('logs-status');
            const q = (document.getElementById('logs-search').value || '').trim().toLowerCase();
            const typeFilter = document.getElementById('logs-type-filter').value;
            let entries = makeEntriesFromLogs(logsCache);
            if (typeFilter === 'in') entries = entries.filter(e => e.type === 'In');
            if (typeFilter === 'out') entries = entries.filter(e => e.type === 'Out');
            if (q) entries = entries.filter(e => (e.name || '').toLowerCase().includes(q) || (e.idNumber || '').toLowerCase().includes(q) || (e.scanner || '').toLowerCase().includes(q));
            // sort
            entries.sort((a, b) => {
                const k = logsSort.by;
                let va = a[k] || '';
                let vb = b[k] || '';
                if (k === 'time') { va = new Date(va).getTime() || 0; vb = new Date(vb).getTime() || 0; }
                if (va < vb) return -1 * logsSort.dir;
                if (va > vb) return 1 * logsSort.dir;
                return 0;
            });
            renderLogsTable(entries);
            statusEl.textContent = entries.length + ' row(s)';
        }

        async function loadLogs() {
            const listEl = document.getElementById('logs-list');
            const statusEl = document.getElementById('logs-status');
            const dateLabel = document.getElementById('logs-date-label');
            statusEl.textContent = 'Loading...';

            // build query if a date is selected
            const dateInput = document.getElementById('logs-date-filter');
            let path = '/api/logs';
            if (dateInput && dateInput.value) {
                // interpret date input as whole-day filter
                const d = new Date(dateInput.value + 'T00:00:00');
                const from = new Date(d);
                const to = new Date(d);
                to.setHours(23, 59, 59, 999);
                const qs = new URLSearchParams({ from: from.toISOString(), to: to.toISOString() });
                path += '?' + qs.toString();
                dateLabel.textContent = new Date(dateInput.value).toLocaleDateString();
            } else {
                dateLabel.textContent = 'All dates';
            }

            try {
                const logs = await api.get(path);
                logsCache = logs || [];
                // Cache successful fetch (only without date filters to keep cache general)
                if (window.NDGM_CACHE && !dateInput.value) {
                    window.NDGM_CACHE.setLogs(logsCache);
                }
                applyLogsUi();
            } catch (err) {
                // Try to use cached data as fallback
                if (window.NDGM_CACHE) {
                    const cached = window.NDGM_CACHE.getLogs();
                    if (cached && cached.length > 0) {
                        console.log('Using cached logs (offline)');
                        logsCache = cached;
                        applyLogsUi();
                        statusEl.textContent = '‚ö†Ô∏è Offline - showing cached data (' + cached.length + ' logs)';
                        return;
                    }
                }
                statusEl.textContent = '';
                listEl.innerHTML = '<p class="msg error">' + (err.data?.error || err.message || 'Failed to load logs.') + '</p>';
            }
        }
        document.getElementById('btn-refresh-logs').addEventListener('click', loadLogs);
        // wire search/filter inputs
        document.getElementById('logs-search').addEventListener('input', function () { applyLogsUi(); });
        document.getElementById('logs-type-filter').addEventListener('change', function () { applyLogsUi(); });
        // date filter
        document.getElementById('logs-date-filter').addEventListener('change', function () { loadLogs(); });
        document.getElementById('btn-clear-logs-date').addEventListener('click', function () { document.getElementById('logs-date-filter').value = ''; loadLogs(); });

        // ‚Äî‚Äî‚Äî Users ‚Äî‚Äî‚Äî
        var usersCache = [];
        var usersSort = { by: 'name', dir: 1 };
        var editingUserId = null;

        function renderUsersTable(list) {
            const listEl = document.getElementById('users-list');
            if (!list || list.length === 0) {
                listEl.innerHTML = '<p class="panel-status">No users found.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const cols = [
                { key: 'name', label: 'Name' },
                { key: 'idNumber', label: 'ID Number' },
                { key: 'role', label: 'Role' },
                { key: 'actions', label: 'Edit' },
            ];
            cols.forEach(c => {
                const th = document.createElement('th');
                th.textContent = c.label;
                if (c.key !== 'actions') {
                    th.style.cursor = 'pointer';
                    th.addEventListener('click', function () {
                        if (usersSort.by === c.key) usersSort.dir = -usersSort.dir; else { usersSort.by = c.key; usersSort.dir = 1; }
                        applyUsersUi();
                    });
                }
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            list.forEach(u => {
                const tr = document.createElement('tr');
                const tName = document.createElement('td'); tName.textContent = u.name || '‚Äî'; tr.appendChild(tName);
                const tId = document.createElement('td'); tId.textContent = u.idNumber || '‚Äî'; tr.appendChild(tId);
                const tRole = document.createElement('td'); tRole.textContent = u.role || '‚Äî'; tr.appendChild(tRole);
                const tActions = document.createElement('td');
                const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'Edit';
                btn.addEventListener('click', function () { openUserModal(u); });
                tActions.appendChild(btn);
                tr.appendChild(tActions);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            listEl.innerHTML = '';
            listEl.appendChild(table);
        }

        function applyUsersUi() {
            const q = (document.getElementById('users-search').value || '').trim().toLowerCase();
            const roleFilter = document.getElementById('users-role-filter').value;
            let list = (usersCache || []).slice();
            if (roleFilter && roleFilter !== 'all') list = list.filter(u => (u.role || '').toLowerCase() === roleFilter.toLowerCase());
            if (q) list = list.filter(u => (u.name || '').toLowerCase().includes(q) || (u.idNumber || '').toLowerCase().includes(q));
            list.sort((a, b) => {
                const k = usersSort.by;
                const va = (a[k] || '').toString().toLowerCase();
                const vb = (b[k] || '').toString().toLowerCase();
                if (va < vb) return -1 * usersSort.dir;
                if (va > vb) return 1 * usersSort.dir;
                return 0;
            });
            renderUsersTable(list);
            document.getElementById('users-status').textContent = list.length + ' user(s)';
        }

        async function loadUsers() {
            const listEl = document.getElementById('users-list');
            const statusEl = document.getElementById('users-status');
            if (!api.getToken()) {
                listEl.innerHTML = '<p class="panel-status">Login required to view users.</p>';
                return;
            }
            statusEl.textContent = 'Loading...';
            try {
                const users = await api.getUsers();
                usersCache = users || [];
                // Cache successful fetch
                if (window.NDGM_CACHE) {
                    window.NDGM_CACHE.setUsers(usersCache);
                }
                applyUsersUi();
            } catch (err) {
                // Try to use cached data as fallback
                if (window.NDGM_CACHE) {
                    const cached = window.NDGM_CACHE.getUsers();
                    if (cached && cached.length > 0) {
                        console.log('Using cached users (offline)');
                        usersCache = cached;
                        applyUsersUi();
                        statusEl.textContent = '‚ö†Ô∏è Offline - showing cached data (' + cached.length + ' users)';
                        return;
                    }
                }
                statusEl.textContent = '';
                listEl.innerHTML = '<p class="msg error">' + (err.data?.error || err.message || 'Failed to load users.') + '</p>';
            }
        }

        document.getElementById('btn-refresh-users').addEventListener('click', loadUsers);
        document.getElementById('users-search').addEventListener('input', applyUsersUi);
        document.getElementById('users-role-filter').addEventListener('change', applyUsersUi);
        document.getElementById('btn-create-user').addEventListener('click', function () { openUserModal(null); });

        // User modal handlers
        var userModalOverlay = document.getElementById('user-modal-overlay');
        var userNameEl = document.getElementById('user-name');
        var userIdEl = document.getElementById('user-idNumber');
        var userRoleEl = document.getElementById('user-role');
        var userMsgEl = document.getElementById('user-msg');

        function openUserModal(user) {
            editingUserId = user && user._id ? user._id : null;
            document.getElementById('user-modal-title').textContent = editingUserId ? 'Edit user' : 'Create user';
            userNameEl.value = user && user.name ? user.name : '';
            userIdEl.value = user && user.idNumber ? user.idNumber : '';
            userRoleEl.value = user && user.role ? user.role : 'student';
            userMsgEl.style.display = 'none';
            document.getElementById('btn-user-delete').style.display = editingUserId ? 'inline-block' : 'none';
            userModalOverlay.classList.add('open');
            userNameEl.focus();
        }

        function closeUserModal() {
            userModalOverlay.classList.remove('open');
            editingUserId = null;
        }

        document.getElementById('btn-user-modal-close').addEventListener('click', closeUserModal);
        document.getElementById('btn-user-cancel').addEventListener('click', closeUserModal);

        document.getElementById('btn-user-save').addEventListener('click', async function () {
            var name = userNameEl.value.trim();
            var idNumber = userIdEl.value.trim();
            var role = userRoleEl.value;
            if (!name || !idNumber) {
                userMsgEl.textContent = 'Name and ID Number are required.';
                userMsgEl.className = 'msg error';
                userMsgEl.style.display = 'block';
                return;
            }
            userMsgEl.style.display = 'none';
            try {
                if (editingUserId) {
                    await api.patch('/api/users/' + editingUserId, { name: name, idNumber: idNumber, role: role });
                    // update cache locally
                    usersCache = usersCache.map(u => u._id === editingUserId ? Object.assign({}, u, { name, idNumber, role }) : u);
                } else {
                    const res = await api.register(name, idNumber, role);
                    // try to use returned user, otherwise add a local entry
                    var newUser = res && res.user ? res.user : { _id: 'local-' + Date.now(), name: name, idNumber: idNumber, role: role, dateCreated: new Date().toISOString() };
                    usersCache.unshift(newUser);
                }
                applyUsersUi();
                closeUserModal();
                // restore focus to prevent input lock
                setTimeout(function() {
                    const searchInput = document.getElementById('users-search');
                    if (searchInput) searchInput.focus();
                }, 100);
            } catch (err) {
                userMsgEl.textContent = (err.data && err.data.error) || err.message || 'Save failed.';
                userMsgEl.className = 'msg error';
                userMsgEl.style.display = 'block';
            }
        });

        document.getElementById('btn-user-delete').addEventListener('click', async function () {
            if (!editingUserId) return;
            if (!confirm('Delete this user?')) return;
            try {
                await api.delete('/api/users/' + editingUserId);
                usersCache = usersCache.filter(u => u._id !== editingUserId);
                applyUsersUi();
                closeUserModal();
                // restore focus after modal close to prevent input lock
                setTimeout(function() {
                    const searchInput = document.getElementById('users-search');
                    if (searchInput) searchInput.focus();
                }, 100);
            } catch (err) {
                userMsgEl.textContent = (err.data && err.data.error) || err.message || 'Delete failed.';
                userMsgEl.className = 'msg error';
                userMsgEl.style.display = 'block';
            }
        });
    </script>
</body>
</html>
